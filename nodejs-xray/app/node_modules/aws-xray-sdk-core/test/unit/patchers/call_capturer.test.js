var assert = require('chai').assert;
var sinon = require('sinon');
var fs = require('fs');

var CallCapturer = require('../../../lib/patchers/call_capturer');

describe('CallCapturer', function() {
  var sandbox;

  beforeEach(function() {
    sandbox = sinon.sandbox.create();
  });

  afterEach(function() {
    sandbox.restore();
  });

  describe('#constructor', function() {
    var jsonDoc = {
      services: {
        s3: {}
      }
    };

    it('should return a call capturer object loaded with the default JSON document', function() {
      var capturer = new CallCapturer();

      assert.instanceOf(capturer, CallCapturer);
      assert.property(capturer.services, 'dynamodb');
    });

    it('should return a call capturer object loaded with a custom JSON document', function() {
      sandbox.stub(fs, 'readFileSync').returns();
      sandbox.stub(JSON, 'parse').returns(jsonDoc);

      var capturer = new CallCapturer('/custom/path');

      assert.instanceOf(capturer, CallCapturer);
      assert.property(capturer.services, 's3');
    });
  });

  describe('#capture', function() {
    var jsonDocDynamoParams, jsonDocDynamoDesc, jsonDocSQS, responseDynamo, responseSQS;

    beforeEach(function() {
      responseDynamo = {
        request: {
          operation: 'getItem',
          params: {
            TableName: 'myTable',
            ProjectionExpression: 'Table',
            ConsistentRead: true,
            ExpressionAttributeNames: {
              '#attrName': 'SessionID'
            }
          }
        },
        ConsumedCapacity: '10',
        data: {
          TableNames: ['hello']
        }
      };

      responseSQS = {
        request: {
          operation: 'sendMessageBatch',
          params: {}
        },
        data: {
          Failed: [1,2,3],
          Successful: [1,2,3,4,5,6,7]
        }
      };

      jsonDocDynamoParams = {
        services: {
          dynamodb: {
            operations: {
              getItem: {
                request_parameters: [ 'TableName' ],
                response_parameters: [ 'ConsumedCapacity' ]
              }
            }
          }
        }
      };

      jsonDocDynamoDesc = {
        services: {
          dynamodb: {
            operations: {
              getItem: {
                request_descriptors: {
                  ExpressionAttributeNames: {
                    get_keys: true,
                    rename_to: 'attribute_names_substituted'
                  }
                },
                response_descriptors: {
                  TableNames: {
                    list: true,
                    get_count: true
                  }
                }
              }
            }
          }
        }
      };

      jsonDocSQS = {
        services: {
          sqs: {
            operations: {
              sendMessageBatch: {
                response_descriptors: {
                  Failed: {
                    list: true,
                    get_count: true,
                  },
                  Successful: {
                    list: true,
                    get_count: true,
                  },
                }
              }
            }
          }
        }
      };
    });

    it('should capture the request and response params noted', function () {
      sandbox.stub(fs, 'readFileSync').returns();
      sandbox.stub(JSON, 'parse').returns(jsonDocDynamoParams);

      var capturer = new CallCapturer('/path/here');
      var data = capturer.capture('dynamodb', responseDynamo);

      assert.deepEqual(data, { table_name: 'myTable', consumed_capacity: '10' });
    });

    it('should capture falsey request and response params noted', function () {
      sandbox.stub(fs, 'readFileSync').returns();
      sandbox.stub(JSON, 'parse').returns(jsonDocDynamoParams);

      responseDynamo.request.params.TableName = false;

      var capturer = new CallCapturer('/path/here');
      var data = capturer.capture('dynamodb', responseDynamo);

      assert.deepEqual(data, { table_name: false, consumed_capacity: '10' });
    });

    it('should not capture the request param if missing', function () {
      sandbox.stub(fs, 'readFileSync').returns();
      sandbox.stub(JSON, 'parse').returns(jsonDocDynamoParams);

      delete responseDynamo.request.params.TableName;

      var capturer = new CallCapturer('/path/here');
      var data = capturer.capture('dynamodb', responseDynamo);

      assert.notProperty(data, 'table_name');
      assert.propertyVal(data, 'consumed_capacity', '10');
    });

    it('should not capture the response param if missing', function () {
      sandbox.stub(fs, 'readFileSync').returns();
      sandbox.stub(JSON, 'parse').returns(jsonDocDynamoParams);

      delete responseDynamo.ConsumedCapacity;

      var capturer = new CallCapturer('/path/here');
      var data = capturer.capture('dynamodb', responseDynamo);

      assert.notProperty(data, 'consumed_capacity');
    });

    it('should capture the request descriptors as noted', function () {
      sandbox.stub(fs, 'readFileSync').returns();
      sandbox.stub(JSON, 'parse').returns(jsonDocDynamoDesc);

      var capturer = new CallCapturer('/path/here');
      var data = capturer.capture('dynamodb', responseDynamo);

      assert.deepEqual(data, { attribute_names_substituted: [ '#attrName' ], table_names: 1 });
    });

    it('should capture falsey request descriptors noted', function () {
      delete jsonDocDynamoDesc.services.dynamodb.operations.getItem.request_descriptors.ExpressionAttributeNames.get_keys;
      delete jsonDocDynamoDesc.services.dynamodb.operations.getItem.request_descriptors.ExpressionAttributeNames.rename_to;

      sandbox.stub(fs, 'readFileSync').returns();
      sandbox.stub(JSON, 'parse').returns(jsonDocDynamoDesc);

      responseDynamo.request.params.ExpressionAttributeNames = false;

      var capturer = new CallCapturer('/path/here');
      var data = capturer.capture('dynamodb', responseDynamo);

      assert.propertyVal(data, 'expression_attribute_names', false);
    });

    it('should rename the request descriptor if noted', function () {
      sandbox.stub(fs, 'readFileSync').returns();
      sandbox.stub(JSON, 'parse').returns(jsonDocDynamoDesc);

      var capturer = new CallCapturer('/path/here');
      var data = capturer.capture('dynamodb', responseDynamo);

      assert.property(data, 'attribute_names_substituted');
      assert.deepEqual(data.attribute_names_substituted, [ '#attrName' ]);
    });

    it('should not capture the request descriptor if missing', function () {
      sandbox.stub(fs, 'readFileSync').returns();
      sandbox.stub(JSON, 'parse').returns(jsonDocDynamoDesc);

      delete responseDynamo.request.params.ExpressionAttributeNames;

      var capturer = new CallCapturer('/path/here');
      var data = capturer.capture('dynamodb', responseDynamo);

      assert.notProperty(data, 'attribute_names_substituted');
    });

    it('should capture the response descriptors as noted', function () {
      sandbox.stub(fs, 'readFileSync').returns();
      sandbox.stub(JSON, 'parse').returns(jsonDocSQS);

      var capturer = new CallCapturer('/path/here');
      var data = capturer.capture('sqs', responseSQS);

      assert.deepEqual(data, { failed: 3, successful: 7 });
    });

    it('should not capture the response descriptor if missing', function () {
      sandbox.stub(fs, 'readFileSync').returns();
      sandbox.stub(JSON, 'parse').returns(jsonDocSQS);

      delete responseSQS.data.Failed;

      var capturer = new CallCapturer('/path/here');
      var data = capturer.capture('sqs', responseSQS);

      assert.notProperty(data, 'failed');
      assert.propertyVal(data, 'successful', 7);
    });

    it('should rename the response descriptor if noted', function () {
      jsonDocSQS.services.sqs.operations.sendMessageBatch.response_descriptors.Failed.rename_to = 'error';

      sandbox.stub(fs, 'readFileSync').returns();
      sandbox.stub(JSON, 'parse').returns(jsonDocSQS);

      var capturer = new CallCapturer('/path/here');
      var data = capturer.capture('sqs', responseSQS);

      assert.propertyVal(data, 'error', 3);
    });
  });
});
